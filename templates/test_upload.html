<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Subida de Imagen - Modal Producto R√°pido</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-box {
            border: 2px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        button {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }
        button:hover {
            background: #218838;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .preview {
            margin: 15px 0;
            border: 2px dashed #ccc;
            padding: 10px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview img {
            max-width: 200px;
            max-height: 200px;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test de Subida de Imagen - Modal Producto R√°pido</h1>
        
        <div class="test-box">
            <h3>Test 1: Verificar que la funci√≥n existe</h3>
            <button onclick="testFuncionExiste()">Ejecutar Test</button>
            <div id="test1-result" class="log"></div>
        </div>

        <div class="test-box">
            <h3>Test 2: Subir imagen real</h3>
            <input type="file" id="test-imagen-file" accept="image/*">
            <button onclick="testSubirImagen()">üì§ Subir Imagen</button>
            <div id="test2-status"></div>
            <div id="test2-preview" class="preview">
                <span>Preview aparecer√° aqu√≠</span>
            </div>
            <div id="test2-log" class="log"></div>
        </div>

        <div class="test-box">
            <h3>Test 3: Verificar endpoint API</h3>
            <button onclick="testEndpoint()">Verificar /api/productos/upload-imagen</button>
            <div id="test3-result" class="log"></div>
        </div>

        <div class="test-box">
            <h3>Logs de Consola</h3>
            <button onclick="clearLogs()">Limpiar Logs</button>
            <div id="console-logs" class="log">Los logs aparecer√°n aqu√≠...</div>
        </div>
    </div>

    <script>
        // Capturar console.log
        const originalLog = console.log;
        const originalError = console.error;
        const logsDiv = document.getElementById('console-logs');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logsDiv.innerHTML += '<div style="color: blue;">[LOG] ' + args.join(' ') + '</div>';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logsDiv.innerHTML += '<div style="color: red;">[ERROR] ' + args.join(' ') + '</div>';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        };

        function clearLogs() {
            logsDiv.innerHTML = 'Logs limpiados...<br>';
        }

        function testFuncionExiste() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = '';
            
            if (typeof subirImagenProductoRapido === 'function') {
                resultDiv.innerHTML = '<div style="color: green;">‚úÖ La funci√≥n subirImagenProductoRapido existe</div>';
                resultDiv.innerHTML += '<div>Tipo: ' + typeof subirImagenProductoRapido + '</div>';
                resultDiv.innerHTML += '<div>C√≥digo: ' + subirImagenProductoRapido.toString().substring(0, 200) + '...</div>';
            } else {
                resultDiv.innerHTML = '<div style="color: red;">‚ùå La funci√≥n subirImagenProductoRapido NO existe</div>';
                resultDiv.innerHTML += '<div>Funciones disponibles en window:</div>';
                const funciones = Object.keys(window).filter(key => typeof window[key] === 'function' && key.includes('subir'));
                resultDiv.innerHTML += '<pre>' + JSON.stringify(funciones, null, 2) + '</pre>';
            }
        }

        async function testSubirImagen() {
            const fileInput = document.getElementById('test-imagen-file');
            const statusDiv = document.getElementById('test2-status');
            const previewDiv = document.getElementById('test2-preview');
            const logDiv = document.getElementById('test2-log');
            
            logDiv.innerHTML = '<div>Iniciando test de subida...</div>';
            
            const file = fileInput.files[0];
            if (!file) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Por favor selecciona un archivo primero</div>';
                return;
            }
            
            logDiv.innerHTML += '<div>Archivo seleccionado: ' + file.name + ' (' + file.size + ' bytes)</div>';
            
            const formData = new FormData();
            formData.append('imagen', file);
            
            try {
                statusDiv.innerHTML = '<div class="status info">‚è≥ Subiendo imagen...</div>';
                logDiv.innerHTML += '<div>Enviando POST a /api/productos/upload-imagen...</div>';
                
                const response = await fetch('/api/productos/upload-imagen', {
                    method: 'POST',
                    body: formData
                });
                
                logDiv.innerHTML += '<div>Response status: ' + response.status + '</div>';
                const data = await response.json();
                logDiv.innerHTML += '<div>Response data: ' + JSON.stringify(data) + '</div>';
                
                if (data.success) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Imagen subida exitosamente!</div>';
                    previewDiv.innerHTML = '<img src="' + data.url + '" alt="Preview">';
                    logDiv.innerHTML += '<div style="color: green;">URL: ' + data.url + '</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå Error: ' + data.message + '</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Error: ' + error.message + '</div>';
                logDiv.innerHTML += '<div style="color: red;">Error: ' + error.message + '</div>';
            }
        }

        async function testEndpoint() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = '<div>Verificando endpoint...</div>';
            
            try {
                // Test sin archivo (deber√≠a dar error pero confirmar que el endpoint responde)
                const response = await fetch('/api/productos/upload-imagen', {
                    method: 'POST',
                    body: new FormData()
                });
                
                resultDiv.innerHTML += '<div>Status: ' + response.status + '</div>';
                const data = await response.json();
                resultDiv.innerHTML += '<div>Response: ' + JSON.stringify(data) + '</div>';
                
                if (response.status === 400 && !data.success) {
                    resultDiv.innerHTML += '<div style="color: green;">‚úÖ Endpoint responde correctamente (esperaba error sin archivo)</div>';
                } else if (response.status === 401) {
                    resultDiv.innerHTML += '<div style="color: orange;">‚ö†Ô∏è Endpoint requiere autenticaci√≥n</div>';
                }
            } catch (error) {
                resultDiv.innerHTML += '<div style="color: red;">‚ùå Error al conectar con endpoint: ' + error.message + '</div>';
            }
        }

        // Cargar el script de nueva_cotizacion.js
        console.log('Cargando nueva_cotizacion.js...');
        const script = document.createElement('script');
        script.src = '/static/js/nueva_cotizacion.js?v=20260222';
        script.onload = () => {
            console.log('‚úÖ nueva_cotizacion.js cargado');
            testFuncionExiste();
        };
        script.onerror = () => {
            console.error('‚ùå Error al cargar nueva_cotizacion.js');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>
