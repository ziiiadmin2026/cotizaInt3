<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cotizaci√≥n</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <!-- Toggle Sidebar Mobile -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
    </button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://integrational3.com.mx/logorigen/integrational_std2.png" alt="Integrational3" class="sidebar-logo">
            <h3>Sistema de Cotizaci√≥n</h3>
            <button class="sidebar-close" onclick="toggleSidebar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- User Info -->
        <div class="sidebar-user">
            <div class="user-avatar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <div class="user-details">
                <span class="user-name" id="nombreUsuario">Cargando...</span>
                <span class="user-role">Usuario</span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="#" onclick="abrirModalNuevaCotizacion(); return false;" class="btn-quick-action">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Nueva Cotizaci√≥n
            </a>
        </div>

        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
            <div class="nav-section">
                <span class="nav-section-title">PRINCIPAL</span>
                <a href="#" class="nav-item active" onclick="showTab('clientes'); return false;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>Clientes</span>
                    <span class="badge" id="badge-clientes">0</span>
                </a>
                <a href="#" class="nav-item" onclick="showTab('cotizaciones'); return false;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    <span>Cotizaciones</span>
                    <span class="badge" id="badge-cotizaciones">0</span>
                </a>
            </div>

            <div class="nav-section">
                <span class="nav-section-title">CAT√ÅLOGOS</span>
                <a href="/productos" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/>
                    </svg>
                    <span>Productos</span>
                </a>
            </div>

            <div class="nav-section" id="admin-section" style="display: none;">
                <span class="nav-section-title">ADMINISTRACI√ìN</span>
                <a href="/usuarios" class="nav-item" id="btnUsuarios">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <path d="M20 8v6M23 11h-6"/>
                    </svg>
                    <span>Usuarios</span>
                </a>
            </div>
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <button onclick="cerrarSesion()" class="btn-logout-sidebar">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <path d="M16 17l5-5-5-5M21 12H9"/>
                </svg>
                Cerrar Sesi√≥n
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <header class="topbar">
            <div class="breadcrumb">
                <span id="breadcrumb-text">Inicio / Clientes</span>
            </div>
            <div class="topbar-actions">
                <div class="search-box">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" placeholder="Buscar..." id="global-search">
                </div>
            </div>
        </header>

        <div class="content-wrapper">
        <div id="clientes" class="tab-content active">
            <div class="section-header">
                <h2>Gesti√≥n de Clientes</h2>
                <button class="btn btn-primary" onclick="mostrarFormularioCliente()">Nuevo Cliente</button>
            </div>

            <!-- Formulario de nuevo cliente -->
            <div id="form-cliente" class="form-container" style="display: none;">
                <h3>Nuevo Cliente</h3>
                <form id="cliente-form">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="cliente-nombre" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="cliente-email" required>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" id="cliente-telefono">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <textarea id="cliente-direccion" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>RFC</label>
                        <input type="text" id="cliente-rfc">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Guardar</button>
                        <button type="button" class="btn btn-secondary" onclick="ocultarFormularioCliente()">Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Lista de clientes -->
            <div id="lista-clientes" class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Tel√©fono</th>
                            <th>RFC</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="clientes-tbody">
                        <tr>
                            <td colspan="5" class="text-center">Cargando clientes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pesta√±a de Cotizaciones -->
        <div id="cotizaciones" class="tab-content">
            <div class="section-header">
                <h2>Cotizaciones Recientes</h2>
            </div>

            <div id="lista-cotizaciones" class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>No. Cotizaci√≥n</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Aprobaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cotizaciones-tbody">
                        <tr>
                            <td colspan="6" class="text-center">Cargando cotizaciones...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de detalles de cotizaci√≥n -->
    <div id="modal-cotizacion" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Modal para crear producto r√°pido -->
    <div id="modal-producto-rapido" class="modal modal-producto-rapido" style="display: none;">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <h2 style="margin: 0; color: #1a5490;">Crear Producto R√°pido</h2>
                <button class="btn-close" onclick="cerrarModalProductoRapido()">&times;</button>
            </div>
            <form id="form-producto-rapido">
                <input type="hidden" id="prod-item-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="prod-codigo">C√≥digo *</label>
                        <input type="text" id="prod-codigo" required>
                    </div>

                    <div class="form-group">
                        <label for="prod-tipo">Tipo *</label>
                        <select id="prod-tipo" required>
                            <option value="producto">Producto</option>
                            <option value="servicio">Servicio</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="prod-nombre">Nombre *</label>
                    <input type="text" id="prod-nombre" required>
                </div>

                <div class="form-group">
                    <label for="prod-descripcion">Descripci√≥n</label>
                    <textarea id="prod-descripcion" rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="prod-precio">Precio *</label>
                        <input type="number" id="prod-precio" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="prod-unidad">Unidad *</label>
                        <select id="prod-unidad" required>
                            <option value="pza">Pieza</option>
                            <option value="servicio">Servicio</option>
                            <option value="hr">Hora</option>
                            <option value="dia">D√≠a</option>
                            <option value="mes">Mes</option>
                            <option value="kg">Kilogramo</option>
                            <option value="lt">Litro</option>
                            <option value="m">Metro</option>
                            <option value="m2">Metro cuadrado</option>
                            <option value="m3">Metro c√∫bico</option>
                            <option value="caja">Caja</option>
                            <option value="paquete">Paquete</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="prod-categoria">Categor√≠a</label>
                        <input type="text" id="prod-categoria" list="prod-categoriasList" placeholder="Ej: Hardware, Software, Servicio">
                        <datalist id="prod-categoriasList">
                            <option value="Hardware">
                            <option value="Software">
                            <option value="Servicio">
                            <option value="Networking">
                            <option value="Licencias">
                            <option value="Consumibles">
                        </datalist>
                    </div>

                    <div class="form-group">
                        <label for="prod-activo">Estado *</label>
                        <select id="prod-activo" required>
                            <option value="1" selected>Activo</option>
                            <option value="0">Inactivo</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Imagen del Producto</label>
                    <div class="imagen-upload-container-rapido">
                        <div class="imagen-controls-rapido">
                            <input type="file" id="prod-imagen-file" accept="image/*">
                            <button type="button" id="btn-subir-imagen-rapido" class="btn-upload-rapido" onclick="subirImagenProductoRapido()">üì§ Subir Imagen</button>
                            <input type="text" id="prod-imagen-url" placeholder="O ingresa URL: https://ejemplo.com/imagen.jpg">
                            <small style="display: block; margin-top: 5px; color: #666;">Sube una imagen local (PNG, JPG, GIF, WEBP) o ingresa una URL p√∫blica</small>
                        </div>
                        <div id="prod-imagen-preview" class="imagen-preview-box-rapido">
                            <span class="imagen-preview-text-rapido">Sin imagen</span>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalProductoRapido()">Cancelar</button>
                    <button type="submit" class="btn btn-success">üíæ Crear Producto</button>
                </div>
            </form>
        </div>
    </div>

        </div>
    </div>

    <!-- Modal Nueva Cotizaci√≥n -->
    <div id="modalNuevaCotizacion" class="modal" style="display: none;">
        <div class="modal-content modal-cotizacion">
            <div class="modal-header">
                <h2>Nueva Cotizaci√≥n</h2>
                <button class="btn-close" onclick="cerrarModalNuevaCotizacion()">&times;</button>
            </div>
            
            <form id="cotizacion-form">
                <div class="form-section">
                    <h3>Datos del Cliente</h3>
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select id="cotizacion-cliente" required>
                            <option value="">Seleccione un cliente...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Validez</label>
                        <input type="date" id="cotizacion-validez">
                    </div>
                </div>

                <div class="form-section">
                    <h3>Conceptos</h3>
                    <div id="items-container"></div>
                    <button type="button" class="btn btn-secondary" onclick="agregarItem()">+ Agregar Concepto</button>
                </div>

                <div class="form-section">
                    <h3>Totales</h3>
                    <div class="totales-box">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal-display">$0.00</span>
                        </div>
                        <div class="total-row">
                            <span>IVA (16%):</span>
                            <span id="iva-display">$0.00</span>
                        </div>
                        <div class="total-row total-final">
                            <span>TOTAL:</span>
                            <span id="total-display">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Notas</h3>
                    <div class="form-group">
                        <textarea id="cotizacion-notas" rows="3" placeholder="Notas adicionales, especificaciones, etc."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Condiciones Comerciales</h3>
                    <div class="form-group">
                        <textarea id="cotizacion-condiciones" rows="4" placeholder="Ejemplo:&#10;‚Ä¢ Tiempo de entrega: 20 d√≠as&#10;‚Ä¢ Condiciones de pago: 50% anticipo, 50% contra entrega&#10;‚Ä¢ Vigencia: 15 d√≠as"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Adjuntos</h3>
                    <div class="form-group">
                        <input type="file" id="cotizacion-adjuntos" multiple>
                        <small>M√°x. 5 archivos, 15 MB c/u (PDF, Office, im√°genes, ZIP).</small>
                    </div>
                    <div id="adjuntos-existentes"></div>
                    <div id="adjuntos-seleccionados"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">üíæ Guardar Cotizaci√≥n</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalNuevaCotizacion()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notificaciones -->
    <div id="notification" class="notification"></div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/nueva_cotizacion.js') }}?v=20260222"></script>
    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function abrirModalNuevaCotizacion() {
            document.getElementById('modalNuevaCotizacion').style.display = 'flex';
            
            // Inicializar datos si no est√°n cargados
            if (typeof cargarClientesSelect === 'function') {
                cargarClientesSelect();
            }
            if (typeof cargarProductos === 'function' && (!productos || productos.length === 0)) {
                cargarProductos();
            }
            
            // Agregar primer item por defecto si el contenedor est√° vac√≠o
            const itemsContainer = document.getElementById('items-container');
            if (itemsContainer && itemsContainer.children.length === 0) {
                if (typeof agregarItem === 'function') {
                    agregarItem();
                }
            }
            
            // Agregar event listener al formulario si no existe
            const formCotizacion = document.getElementById('cotizacion-form');
            if (formCotizacion && !formCotizacion.hasAttribute('data-listener')) {
                formCotizacion.addEventListener('submit', crearCotizacion);
                formCotizacion.setAttribute('data-listener', 'true');
            }
            
            // Agregar event listener al formulario de producto r√°pido
            const formProdRapido = document.getElementById('form-producto-rapido');
            if (formProdRapido && !formProdRapido.hasAttribute('data-listener')) {
                formProdRapido.addEventListener('submit', crearProductoRapido);
                formProdRapido.setAttribute('data-listener', 'true');
            }
        }
        
        function cerrarModalNuevaCotizacion() {
            document.getElementById('modalNuevaCotizacion').style.display = 'none';
            // Limpiar formulario
            const form = document.getElementById('cotizacion-form');
            if (form) {
                form.reset();
            }
            const itemsContainer = document.getElementById('items-container');
            if (itemsContainer) {
                itemsContainer.innerHTML = '';
            }
            if (typeof calcularTotales === 'function') {
                calcularTotales();
            }
        }
        
        // Protecci√≥n contra ESC para el modal de producto r√°pido
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modalProducto = document.getElementById('modal-producto-rapido');
                const modalCotizacion = document.getElementById('modalNuevaCotizacion');
                
                // Prevenir cierre si cualquiera de los modales est√° abierto
                if ((modalProducto && modalProducto.style.display === 'flex') ||
                    (modalCotizacion && modalCotizacion.style.display === 'flex')) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        });
    </script>
</body>
</html>
